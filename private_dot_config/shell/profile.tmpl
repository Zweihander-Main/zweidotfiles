#!/bin/zsh

# profile file. Runs on login. Environmental variables are set here.

# If you don't plan on reverting to bash, you can remove the link in ~/.profile
# to clean up.

# if running bash
if [ -n "$BASH_VERSION" ]; then
    # If not running interactively, don't do anything
    case $- in
        *i*) ;;
            *) return;;
    esac
    # Switch to ZSH
    if test -t 1; then
        exec zsh
    fi
fi

# Default programs:
export EDITOR="vim"
export TERMINAL="alacritty"
export BROWSER="chromium"

# Home directory clean-up:
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"
export XDG_CACHE_HOME="$HOME/.cache"
export XINITRC="${XDG_CONFIG_HOME}/x11/xinitrc"
export XSERVERRC="${XDG_CONFIG_HOME}/x11/xserverrc"
export XAUTHORITY="${XDG_RUNTIME_DIR}/Xauthority" # This line will break some DMs.
export GNUPGHOME="${XDG_DATA_HOME}/gnupg"
export HISTFILE="${XDG_DATA_HOME}/shell/history"
export CARGO_HOME="${XDG_DATA_HOME}/cargo"
export RUSTUP_HOME="${XDG_DATA_HOME}/rustup"
export WGETRC="${XDG_CONFIG_HOME}/wgetrc"
export LESSKEY="${XDG_CONFIG_HOME}/less/lesskey"
export LESSHISTFILE="${XDG_CACHE_HOME}/less/history"
export VIMINIT="set nocp | source ${XDG_CONFIG_HOME}/vim/vimrc"

# Other program settings:
export _JAVA_AWT_WM_NONREPARENTING=1	# Fix for Java applications in dwm
export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01' # GCC Warning colors

# GnuPG/SSH
unset SSH_AGENT_PID
if [ "${gnupg_SSH_AUTH_SOCK_by:-0}" -ne $$ ]; then
  export SSH_AUTH_SOCK="$(gpgconf --list-dirs agent-ssh-socket)"
fi
export GPG_TTY=$(tty)
gpg-connect-agent updatestartuptty /bye >/dev/null

# PATH updates:
[ -d "$HOME/bin" ] && PATH="$HOME/bin:$PATH"
[ -d "$HOME/.emacs.d/bin" ] && PATH="$HOME/.emacs.d/bin:$PATH"
[ -d "$HOME/.local/bin" ] && PATH="$HOME/.local/bin:$PATH"

# NVM
[ -z "$NVM_DIR" ] && export NVM_DIR="$XDG_DATA_HOME/nvm"
[ -s "/usr/share/nvm/nvm.sh" ] && source /usr/share/nvm/nvm.sh
[ -s "/usr/share/nvm/bash_completion" ] && source /usr/share/nvm/bash_completion
[ -s "/usr/share/nvm/install-nvm-exec" ] && source /usr/share/nvm/install-nvm-exec

# History settings
HISTCONTROL=ignoreboth # don't put duplicate lines or lines starting with space in the history.
HISTSIZE=50000

# Apparish (bookmarks)
APPARIXHOME="${XDG_DATA_HOME}/apparish"
APPARIXRC="${APPARIXHOME}/apparixrc"
APPARIXEXPAND="${APPARIXHOME}/apparixexpand"
APPARIXLOG="${APPARIXHOME}/apparixlog"
source "${XDG_DATA_HOME}/apparish/bourne-apparish"


# If WSL
{{ if .chezmoi.kernel.osrelease | regexMatch "-microsoft-standard$" -}}
# add Android SDK platform tools to path
if [ -d "$HOME/platform-tools" ] ; then
    PATH="$HOME/platform-tools:$PATH"
fi

# Android development
export USE_CCACHE=1
export JACK_SERVER_VM_ARGUMENTS="-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx4096m"
export NVM_DIR="$HOME/.nvm"

# WSL SSH bridge - https://codingnest.com/how-to-use-gpg-with-yubikey-wsl/
export SSH_AUTH_SOCK="/mnt/c/dev/utils/wsl-ssh-pageant/ssh-agent.sock"

# vcxsrv
export DISPLAY=:0
export LIBGL_ALWAYS_INDIRECT=1

{{ else -}} # Not WSL
# Automatic login
if [ -z "${DISPLAY}" ] && [ "${XDG_VTNR}" -eq 1 ]; then
  exec startx "${XDG_CONFIG_HOME}/x11/xinitrc" -- -keeptty &> "${XDG_DATA_HOME}/xorg/xorg.tty.log" # exec forces it back out when x session dies
fi
{{ end -}} # End templating

